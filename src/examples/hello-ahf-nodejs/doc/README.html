<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
  </style>
  <link href="data:text/css;charset=utf-8,%0Ahtml%20%7B%0Afont%2Dsize%3A%20100%25%3B%0Aoverflow%2Dy%3A%20scroll%3B%0A%2Dwebkit%2Dtext%2Dsize%2Dadjust%3A%20100%25%3B%0A%2Dms%2Dtext%2Dsize%2Dadjust%3A%20100%25%3B%0A%7D%0Abody%20%7B%0Acolor%3A%20%23444%3B%0Afont%2Dfamily%3A%20Georgia%2C%20Palatino%2C%20%27Palatino%20Linotype%27%2C%20Times%2C%20%27Times%20New%20Roman%27%2C%20serif%3B%0Afont%2Dsize%3A%2012px%3B%0Aline%2Dheight%3A%201%2E7%3B%0Apadding%3A%201em%3B%0Amargin%3A%20auto%3B%0Amax%2Dwidth%3A%2042em%3B%0Abackground%3A%20%23fefefe%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230645ad%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%230b0080%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%2306e%3B%0A%7D%0Aa%3Aactive%20%7B%0Acolor%3A%20%23faa700%3B%0A%7D%0Aa%3Afocus%20%7B%0Aoutline%3A%20thin%20dotted%3B%0A%7D%0A%2A%3A%3A%2Dmoz%2Dselection%20%7B%0Abackground%3A%20rgba%28255%2C%20255%2C%200%2C%200%2E3%29%3B%0Acolor%3A%20%23000%3B%0A%7D%0A%2A%3A%3Aselection%20%7B%0Abackground%3A%20rgba%28255%2C%20255%2C%200%2C%200%2E3%29%3B%0Acolor%3A%20%23000%3B%0A%7D%0Aa%3A%3A%2Dmoz%2Dselection%20%7B%0Abackground%3A%20rgba%28255%2C%20255%2C%200%2C%200%2E3%29%3B%0Acolor%3A%20%230645ad%3B%0A%7D%0Aa%3A%3Aselection%20%7B%0Abackground%3A%20rgba%28255%2C%20255%2C%200%2C%200%2E3%29%3B%0Acolor%3A%20%230645ad%3B%0A%7D%0Ap%20%7B%0Amargin%3A%201em%200%3B%0A%7D%0Aimg%20%7B%0Amax%2Dwidth%3A%20100%25%3B%0A%7D%0Ah1%2C%20h2%2C%20h3%2C%20h4%2C%20h5%2C%20h6%20%7B%0Acolor%3A%20%23111%3B%0Aline%2Dheight%3A%20125%25%3B%0Amargin%2Dtop%3A%202em%3B%0Afont%2Dweight%3A%20normal%3B%0A%7D%0Ah4%2C%20h5%2C%20h6%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Ah1%20%7B%0Afont%2Dsize%3A%202%2E5em%3B%0A%7D%0Ah2%20%7B%0Afont%2Dsize%3A%202em%3B%0A%7D%0Ah3%20%7B%0Afont%2Dsize%3A%201%2E5em%3B%0A%7D%0Ah4%20%7B%0Afont%2Dsize%3A%201%2E2em%3B%0A%7D%0Ah5%20%7B%0Afont%2Dsize%3A%201em%3B%0A%7D%0Ah6%20%7B%0Afont%2Dsize%3A%200%2E9em%3B%0A%7D%0Ablockquote%20%7B%0Acolor%3A%20%23666666%3B%0Amargin%3A%200%3B%0Apadding%2Dleft%3A%203em%3B%0Aborder%2Dleft%3A%200%2E5em%20%23EEE%20solid%3B%0A%7D%0Ahr%20%7B%0Adisplay%3A%20block%3B%0Aheight%3A%202px%3B%0Aborder%3A%200%3B%0Aborder%2Dtop%3A%201px%20solid%20%23aaa%3B%0Aborder%2Dbottom%3A%201px%20solid%20%23eee%3B%0Amargin%3A%201em%200%3B%0Apadding%3A%200%3B%0A%7D%0Apre%2C%20code%2C%20kbd%2C%20samp%20%7B%0Acolor%3A%20%23000%3B%0Afont%2Dfamily%3A%20monospace%2C%20monospace%3B%0A%5Ffont%2Dfamily%3A%20%27courier%20new%27%2C%20monospace%3B%0Afont%2Dsize%3A%200%2E98em%3B%0A%7D%0Apre%20%7B%0Awhite%2Dspace%3A%20pre%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%0Aword%2Dwrap%3A%20break%2Dword%3B%0A%7D%0Ab%2C%20strong%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Adfn%20%7B%0Afont%2Dstyle%3A%20italic%3B%0A%7D%0Ains%20%7B%0Abackground%3A%20%23ff9%3B%0Acolor%3A%20%23000%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Amark%20%7B%0Abackground%3A%20%23ff0%3B%0Acolor%3A%20%23000%3B%0Afont%2Dstyle%3A%20italic%3B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Asub%2C%20sup%20%7B%0Afont%2Dsize%3A%2075%25%3B%0Aline%2Dheight%3A%200%3B%0Aposition%3A%20relative%3B%0Avertical%2Dalign%3A%20baseline%3B%0A%7D%0Asup%20%7B%0Atop%3A%20%2D0%2E5em%3B%0A%7D%0Asub%20%7B%0Abottom%3A%20%2D0%2E25em%3B%0A%7D%0Aul%2C%20ol%20%7B%0Amargin%3A%201em%200%3B%0Apadding%3A%200%200%200%202em%3B%0A%7D%0Ali%20p%3Alast%2Dchild%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Aul%20ul%2C%20ol%20ol%20%7B%0Amargin%3A%20%2E3em%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dbottom%3A%201em%3B%0A%7D%0Adt%20%7B%0Afont%2Dweight%3A%20bold%3B%0Amargin%2Dbottom%3A%20%2E8em%3B%0A%7D%0Add%20%7B%0Amargin%3A%200%200%20%2E8em%202em%3B%0A%7D%0Add%3Alast%2Dchild%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Aimg%20%7B%0Aborder%3A%200%3B%0A%2Dms%2Dinterpolation%2Dmode%3A%20bicubic%3B%0Avertical%2Dalign%3A%20middle%3B%0A%7D%0Afigure%20%7B%0Adisplay%3A%20block%3B%0Atext%2Dalign%3A%20center%3B%0Amargin%3A%201em%200%3B%0A%7D%0Afigure%20img%20%7B%0Aborder%3A%20none%3B%0Amargin%3A%200%20auto%3B%0A%7D%0Afigcaption%20%7B%0Afont%2Dsize%3A%200%2E8em%3B%0Afont%2Dstyle%3A%20italic%3B%0Amargin%3A%200%200%20%2E8em%3B%0A%7D%0Atable%20%7B%0Amargin%2Dbottom%3A%202em%3B%0Aborder%2Dbottom%3A%201px%20solid%20%23ddd%3B%0Aborder%2Dright%3A%201px%20solid%20%23ddd%3B%0Aborder%2Dspacing%3A%200%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Apadding%3A%20%2E2em%201em%3B%0Abackground%2Dcolor%3A%20%23eee%3B%0Aborder%2Dtop%3A%201px%20solid%20%23ddd%3B%0Aborder%2Dleft%3A%201px%20solid%20%23ddd%3B%0A%7D%0Atable%20td%20%7B%0Apadding%3A%20%2E2em%201em%3B%0Aborder%2Dtop%3A%201px%20solid%20%23ddd%3B%0Aborder%2Dleft%3A%201px%20solid%20%23ddd%3B%0Avertical%2Dalign%3A%20top%3B%0A%7D%0A%2Eauthor%20%7B%0Afont%2Dsize%3A%201%2E2em%3B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%40media%20only%20screen%20and%20%28min%2Dwidth%3A%20480px%29%20%7B%0Abody%20%7B%0Afont%2Dsize%3A%2014px%3B%0A%7D%0A%7D%0A%40media%20only%20screen%20and%20%28min%2Dwidth%3A%20768px%29%20%7B%0Abody%20%7B%0Afont%2Dsize%3A%2016px%3B%0A%7D%0A%7D%0A%40media%20print%20%7B%0A%2A%20%7B%0Abackground%3A%20transparent%20%21important%3B%0Acolor%3A%20black%20%21important%3B%0Afilter%3A%20none%20%21important%3B%0A%2Dms%2Dfilter%3A%20none%20%21important%3B%0A%7D%0Abody%20%7B%0Afont%2Dsize%3A%2012pt%3B%0Amax%2Dwidth%3A%20100%25%3B%0A%7D%0Aa%2C%20a%3Avisited%20%7B%0Atext%2Ddecoration%3A%20underline%3B%0A%7D%0Ahr%20%7B%0Aheight%3A%201px%3B%0Aborder%3A%200%3B%0Aborder%2Dbottom%3A%201px%20solid%20black%3B%0A%7D%0Aa%5Bhref%5D%3Aafter%20%7B%0Acontent%3A%20%22%20%28%22%20attr%28href%29%20%22%29%22%3B%0A%7D%0Aabbr%5Btitle%5D%3Aafter%20%7B%0Acontent%3A%20%22%20%28%22%20attr%28title%29%20%22%29%22%3B%0A%7D%0A%2Eir%20a%3Aafter%2C%20a%5Bhref%5E%3D%22javascript%3A%22%5D%3Aafter%2C%20a%5Bhref%5E%3D%22%23%22%5D%3Aafter%20%7B%0Acontent%3A%20%22%22%3B%0A%7D%0Apre%2C%20blockquote%20%7B%0Aborder%3A%201px%20solid%20%23999%3B%0Apadding%2Dright%3A%201em%3B%0Apage%2Dbreak%2Dinside%3A%20avoid%3B%0A%7D%0Atr%2C%20img%20%7B%0Apage%2Dbreak%2Dinside%3A%20avoid%3B%0A%7D%0Aimg%20%7B%0Amax%2Dwidth%3A%20100%25%20%21important%3B%0A%7D%0A%40page%20%3Aleft%20%7B%0Amargin%3A%2015mm%2020mm%2015mm%2010mm%3B%0A%7D%0A%40page%20%3Aright%20%7B%0Amargin%3A%2015mm%2010mm%2015mm%2020mm%3B%0A%7D%0Ap%2C%20h2%2C%20h3%20%7B%0Aorphans%3A%203%3B%0Awidows%3A%203%3B%0A%7D%0Ah2%2C%20h3%20%7B%0Apage%2Dbreak%2Dafter%3A%20avoid%3B%0A%7D%0A%7D%0A" rel="stylesheet" type="text/css" />
</head>
<body>
<h1 id="nodejs-example">NodeJS example</h1>
<h2 id="previous-steps">Previous steps</h2>
<p>Before starting up this container, ensure that you have the necessary core services up and running. If you are running this from the Arrowhead repository, it should be as simple as running the following command. You can manually substitute the <code>AHF_DOCKER_PATH</code> environment variable if you have not set it up previously.</p>
<p><strong>Linux</strong></p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">docker-compose</span> up --build <span class="ot">${AHF_DOCKER_PATH}</span>/core</code></pre></div>
<p><strong>Windows</strong></p>
<pre class="cmd"><code>&gt; docker-compose up --build %AHF_DOCKER_PATH%\core</code></pre>
<h2 id="how-to-use">How to use</h2>
<p><strong>Linux</strong></p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">docker</span> build -t hello-ahf-java-pure .
$ <span class="kw">docker</span> run --rm \
           --name hello-ahf-java-pure \
           --hostname hello.docker.ahf \
           --net-alias hello.docker.ahf \
           -p 8888:8888 \
           --volume tls:/tls \
           --network ahf \
           hello-ahf-java-pure</code></pre></div>
<p><strong>Windows</strong></p>
<pre class="cmd"><code>&gt; docker build -t hello-ahf-java-pure .
&gt; docker run --rm ^
           --name hello-ahf-java-pure ^
           --hostname hello.docker.ahf ^
           --net-alias hello.docker.ahf ^
           -p 8888:8888 ^
           --volume core_tls:/tls ^
           --network core_ahf ^
           hello-ahf-java-pure</code></pre>
<p>Please note that the network and volume parameters might be different depending on your environment. The given values should work if you started the the core containers using docker-compose in the same machine.</p>
<p>If you are planning on connecting to core services on a remote host, you will need to use a mount volume (i.e. create a Docker volume which allows a directory on your host to be accessed by containers) and provide the corresponding addresses for accessing the remote host.</p>
<h2 id="setup-before-testing">Setup before testing</h2>
<p>Before performing the tests below, you need a certificate signed by the core/glassfish container's CA. This is automatically done by this container. Ideally, you should also use the CA to validate the container's response. This is is also provided.</p>
<p>To retrieve these files, run</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">docker</span> cp hello-ahf-java-pure:/client/ .</code></pre></div>
<p>This will copy the <code>client/</code> directory from the container into your current location. This directory contains the files you need.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">cd</span> client
<span class="kw">ls</span></code></pre></div>
<p>You should also have curl installed or any other similar application for performing web requests.</p>
<p>Finally, your system needs to recognize the hello.docker.ahf host. You can achieve this in multiple ways. The easiest being to modify your hosts file to include the following line (or the corresponding depending on where you are running the container).</p>
<pre class="text"><code>127.0.0.1 hello.docker.ahf</code></pre>
<h2 id="test-calls">Test calls</h2>
<h3 id="setup">Setup</h3>
<p>This endpoint allows the service to register itself on the Service and Authorisation Registries. This is for easy demonstration purposes, security must be considered in real applications.</p>
<p>Currently, the authorisation rule is to allow any caller whose certified name is <code>client.docker.ahf</code> (which is the case for the certificate obtained above).</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">curl</span> -X POST --cert client.pem:changeit --cacert ca.crt https://hello.docker.ahf:8888/setup</code></pre></div>
<h3 id="setdown">Setdown</h3>
<p>This endpoint allows the service to un-register itself from the Service and Authorisation Registries. This is for easy demonstration purposes, security must be considered in real applications.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">curl</span> -X POST --cert client.pem:changeit --cacert ca.crt https://hello.docker.ahf:8888/setdown</code></pre></div>
<h3 id="hello">Hello</h3>
<p>This is an endpoint set to check the identity of the caller and check for authorisation in the Authorisation Registry. If the caller is authorised, the response will be &quot;Hello&quot;, otherwise, the response will inform the caller that they are not authorised.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">curl</span> -X POST --cert client.pem:changeit --cacert ca.crt https://hello.docker.ahf:8888/hello</code></pre></div>
<p>Recommended tests are:</p>
<ul>
<li>Run before doing setup (or after doing setdown).</li>
<li>Run after doing setup.</li>
<li>Run without providing a certificate (removing the <code>--cert</code> parameter).</li>
</ul>
<h2 id="other-usage-scenarios">Other usage scenarios</h2>
<h3 id="resin-with-bootstrapping">Resin with bootstrapping</h3>
<p>[Optional] Ensure that the core containers are already running.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">docker-compose</span> up -f ../../core</code></pre></div>
<p>[Optional] Ensure that the core containers are bootstrap-publishing.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ot">SERVER_ADDRESS=$(</span><span class="kw">docker</span> inspect -f <span class="st">&quot;{{ .NetworkSettings.Networks.core_ahf.IPAddress }}&quot;</span> core_bind_1<span class="ot">)</span>
<span class="kw">[</span> <span class="ot">-n</span> <span class="st">&quot;SERVER_ADDRESS&quot;</span><span class="kw"> ]</span> <span class="kw">&amp;&amp;</span> <span class="kw">\</span>
<span class="kw">docker</span> run \
       --rm \
       --network core_ahf \
       --ip 192.168.10.121 \
       --env URI_SCHEME=<span class="st">&quot;dns&quot;</span> \
       --env URI_HOST=<span class="st">&quot;</span><span class="ot">${SERVER_ADDRESS}</span><span class="st">&quot;</span> \
       --env IP_ADDRESS=<span class="st">&quot;</span><span class="ot">${SERVER_ADDRESS}</span><span class="st">&quot;</span> \
       --env MCAST_INTERFACE=<span class="st">&quot;192.168.10.121&quot;</span> \
       --name socat-bootstrap-server \
       socat-bootstrap-server</code></pre></div>
<p>[Optional] Remove the Docker network.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">docker</span> -H tcp://resin1.local:2375 network rm mcast_net</code></pre></div>
<p>[Optional] Recreate it.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">docker</span> -H tcp://resin1.local:2375 network create \
             -d macvlan \
             --subnet=192.168.10.0/24 \
             --gateway=192.168.10.180 \
             -o parent=eth0 \
             mcast_net</code></pre></div>
<p>[Optional] Create and fill the tls volume (assumes core is running locally)</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">docker</span> -H tcp://resin1.local:2375 volume create tls 
<span class="kw">docker</span> -H tcp://resin1.local:2375 run --rm --name temp --volume tls:/tls -dit alpine
<span class="kw">docker</span> cp core_glassfish_1:/tls/ .
<span class="kw">cd</span> tls
<span class="kw">keytool</span> -import \
    -trustcacerts \
    -alias <span class="st">&quot;ca&quot;</span> \
    -file <span class="st">&quot;ca.crt&quot;</span> \
    -keystore <span class="st">&quot;ca.jks&quot;</span> \
    -storepass <span class="st">&quot;changeit&quot;</span> \
    -noprompt
<span class="kw">sed</span> -i <span class="st">'$ d'</span> generate-signed-cert.sh
<span class="kw">./generate-signed-cert.sh</span> hello-ahf hello.docker.ahf changeit
<span class="kw">./generate-signed-cert.sh</span> client client.docker.ahf changeit
<span class="kw">mkdir</span> -p ../client
<span class="kw">mv</span> client* ca.crt ../client
<span class="kw">docker</span> -H tcp://resin1.local:2375 cp . temp:/tls/
<span class="kw">cd</span> ..
<span class="kw">docker</span> -H tcp://resin1.local:2375 stop temp
<span class="kw">rm</span> -rf tls</code></pre></div>
<p>(Another idea when running all locally -- should build tool container... this requires downloading something extra)</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">docker</span> volume create tls
<span class="kw">docker</span> volume create tsig
<span class="kw">docker</span> run \
       --rm \
       -it \
       --volume core_tls:/core_tls \
       --volume core_tsig:/core_tsig \
       --volume tls:/tls \
       --volume tsig:/tsig \
       openjdk:8-jdk-alpine
<span class="kw">apk</span> --no-cache add openssl
<span class="kw">cd</span> /core_tls
<span class="kw">keytool</span> -import \
    -trustcacerts \
    -alias <span class="st">&quot;ca&quot;</span> \
    -file <span class="st">&quot;ca.crt&quot;</span> \
    -keystore <span class="st">&quot;ca.jks&quot;</span> \
    -storepass <span class="st">&quot;changeit&quot;</span> \
    -noprompt
<span class="kw">./generate-signed-cert.sh</span> hello-ahf hello.docker.ahf changeit
<span class="kw">./generate-signed-cert.sh</span> client client.docker.ahf changeit
<span class="kw">cp</span> -f ./* /tls
<span class="kw">cp</span> -f /core_tsig/tsig /tsig
<span class="kw">exit;</span></code></pre></div>
<p>Build the images.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">docker</span> -H tcp://resin1.local:2375 build \
            --tag socat-bootstrap-client \
            ../../discovery-bootstrapping/multicast/plain/socat/client
<span class="kw">docker</span> -H tcp://resin1.local:2375 build \
            --tag hello-ahf-nodejs .</code></pre></div>
<p>Run the containers.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">docker</span> -H tcp://resin1.local:2375 run \
           --rm \
           --network mcast_net \
           --ip 192.168.10.181 \
           --name socat-bootstrap-client \
           --env OUTPUT_FILENAME=<span class="st">&quot;bootstrap&quot;</span> \
           --volume bootstrapping:/out \
           socat-bootstrap-client
<span class="kw">docker</span> -H tcp://resin1.local:2375 run \
           --rm \
           --network mcast_net \
           --ip 192.168.10.182 \
           --name hello-ahf-nodejs \
           --hostname hello.docker.ahf \
           -p 3111:3111 \
           --volume tls:/tls \
           --volume bootstrapping:/boots \
           --env BOOTSTRAPPING_PATH=<span class="st">&quot;/boots/bootstrap&quot;</span> \
           hello-ahf-nodejs</code></pre></div>
<p>Set the hosts file for the current location of the container</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">sudo</span> sed -Ei <span class="st">&quot;s/^[1-9].*hello\.docker\.ahf/127.0.0.1 hello.docker.ahf/g&quot;</span> /etc/hosts</code></pre></div>
<p>Test</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">curl</span> -X GET --cert client/client.pem:changeit --cacert client/ca.crt https://hello.docker.ahf:3111/setup
<span class="kw">curl</span> -X GET --cert client/client.pem:changeit --cacert client/ca.crt https://hello.docker.ahf:3111/hello
<span class="kw">curl</span> -X GET --cert client/client.pem:changeit --cacert client/ca.crt https://hello.docker.ahf:3111/setdown
<span class="kw">curl</span> -X GET --cert client/client.pem:changeit --cacert client/ca.crt https://hello.docker.ahf:3111/hello</code></pre></div>
<p>Clean up</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">rm</span> -rf client</code></pre></div>
<h2 id="environment-variables">Environment variables</h2>
<p>By setting any of the following environment variables when running the container, you can use it in more complex contexts. For example, you could connect to core services on a remote host, or use a different certificate, obtained from a volume mounted on your host.</p>
<h3 id="keystore_location">KEYSTORE_LOCATION</h3>
<p>Default: <code>hello.jks</code></p>
<h3 id="cacerts_location">CACERTS_LOCATION</h3>
<p>Default: <code>ca.jks</code></p>
<h3 id="keystore_passphrase">KEYSTORE_PASSPHRASE</h3>
<p>Default: <code>changeit</code></p>
<h3 id="service_discovery_url">SERVICE_DISCOVERY_URL</h3>
<p>Default: <code>http://simpleservicediscovery.docker.ahf:8045/servicediscovery</code></p>
<h3 id="orchestration_url">ORCHESTRATION_URL</h3>
<p>Default: <code>https://glassfish.docker.ahf:8181/orchestration/store</code></p>
<h3 id="authorisation_url">AUTHORISATION_URL</h3>
<p>Default: <code>http://glassfish.docker.ahf:8080/authorisation</code></p>
<h3 id="authorisation_control_url">AUTHORISATION_CONTROL_URL</h3>
<p>Default: <code>https://glassfish.docker.ahf:8181/authorisation-control</code></p>
<h3 id="authorized_cn">AUTHORIZED_CN</h3>
<p>Default: <code>client.docker.ahf</code></p>
<h3 id="port">PORT</h3>
<p>Default: <code>8888</code></p>
<h3 id="bootstrapping_path">BOOTSTRAPPING_PATH</h3>
<p>No default.</p>
<h3 id="virtualbox-demo-execute-from-ahf-docker">Virtualbox demo execute from ahf-docker/</h3>
<p>Missing: * Hello must register itself with DNS</p>
<p>Preparation: * Might need to open ports inside the NAT? I assume they are just not closed in the local network. * Create TLS and TSIG in VM 1 * Copy them to VM 2 and VM 3</p>
<p>Steps: VM 1: * Run the core containers detached * Run DNS bootstrapper detached same VM</p>
<p>VM 2: * Run bootstrapper leading to volume * Run hello-nodejs connected to bootstrapping, TLS and TSIG volumes with the necessary port open</p>
<p>VM 3: * Run test calls to hello-nodejs</p>
<ul>
<li><p>Start the VMs</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">VBoxManage</span> startvm ud1 --type headless
<span class="kw">VBoxManage</span> startvm ud2 --type headless
<span class="kw">VBoxManage</span> startvm ud3 --type headless
<span class="kw">ssh</span> r@10.0.0.1 -p22222
<span class="kw">ssh</span> r@10.0.0.2 -p22222
<span class="kw">ssh</span> r@10.0.0.3 -p22222</code></pre></div></li>
<li><p>Create TLS and TSIG in VM 1</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">docker-compose</span> -f core/docker-compose.yml run glassfish tls</code></pre></div></li>
<li><p>Copy them to removable media ```bash mkdir -p .media/tls .media/tsig sudo cp -far &quot;$(docker volume inspect core_tls -f '{{ .Mountpoint }}')/.&quot; .media/tls/ &amp;&amp; sudo chown -R <span class="math inline"><em>U</em><em>S</em><em>E</em><em>R</em>:</span>{USER} .media/tls</p></li>
</ul>
<p>cd .media/tls keytool -import<br />
-trustcacerts<br />
-alias &quot;ca&quot;<br />
-file &quot;ca.crt&quot;<br />
-keystore &quot;ca.jks&quot;<br />
-storepass &quot;changeit&quot;<br />
-noprompt ./generate-signed-cert.sh hello-ahf hello.docker.ahf changeit ./generate-signed-cert.sh client client.docker.ahf changeit cd - sudo cp -far &quot;$(docker volume inspect core_tsig -f '{{ .Mountpoint }}')/.&quot; .media/tsig/ &amp;&amp; sudo chown -R <span class="math inline"><em>U</em><em>S</em><em>E</em><em>R</em>:</span>{USER} .media/tls device_path=/dev/sda1 sudo umount .media sudo mount &quot;${device_path}&quot; .media &amp;&amp;<br />
cp -far tls tsig .media/ sudo umount .media rm -rf .media ```</p>
<ul>
<li><p>Copy them to VM 2 and VM 3 On VM 1</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">mkdir</span> -p ~/tls ~/tsig<span class="kw">;</span>
<span class="kw">sudo</span> cp -far <span class="st">&quot;</span><span class="ot">$(</span><span class="kw">docker</span> volume inspect core_tls -f <span class="st">'{{ .Mountpoint }}'</span><span class="ot">)</span><span class="st">/.&quot;</span> ~/tls/ <span class="kw">&amp;&amp;</span> <span class="kw">sudo</span> chown -R <span class="ot">${USER}</span>:<span class="ot">${USER}</span> ~/tls<span class="kw">;</span> 
<span class="kw">sudo</span> cp -far <span class="st">&quot;</span><span class="ot">$(</span><span class="kw">docker</span> volume inspect core_tsig -f <span class="st">'{{ .Mountpoint }}'</span><span class="ot">)</span><span class="st">/.&quot;</span> ~/tsig/ <span class="kw">&amp;&amp;</span> <span class="kw">sudo</span> chown -R <span class="ot">${USER}</span>:<span class="ot">${USER}</span> ~/tsig<span class="kw">;</span></code></pre></div></li>
</ul>
<p>On the host</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="co"># TODO: Check contents</span>
<span class="kw">scp</span> -P 22222 -r r@10.0.0.1:~/tls/ tls
<span class="kw">scp</span> -P 22222 -r r@10.0.0.1:~/tsig/ tsig
<span class="kw">cd</span> tls
<span class="kw">keytool</span> -import \
    -trustcacerts \
    -alias <span class="st">&quot;ca&quot;</span> \
    -file <span class="st">&quot;ca.crt&quot;</span> \
    -keystore <span class="st">&quot;ca.jks&quot;</span> \
    -storepass <span class="st">&quot;changeit&quot;</span> \
    -noprompt
<span class="kw">./generate-signed-cert.sh</span> hello-ahf hello.docker.ahf changeit
<span class="kw">./generate-signed-cert.sh</span> client client.docker.ahf changeit
<span class="kw">cd</span> -
<span class="kw">scp</span> -P 22222 -r tls/ tsig/ r@10.0.0.2:~/
<span class="kw">scp</span> -P 22222 -r tls/ tsig/ r@10.0.0.3:~/
<span class="kw">rm</span> -rf tls/ tsig/</code></pre></div>
<p>[Optional] Ensure that the core containers are already running.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">docker-compose</span> -f ~/ahf-docker/core/docker-compose.yml up -d</code></pre></div>
<p>[Optional] Ensure that the core containers are bootstrap-publishing.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">docker</span> build \
       --tag socat-bootstrap-server \
       ~/ahf-docker/discovery-bootstrapping/multicast/plain/socat/core/
<span class="kw">docker</span> run \
       --restart always \
       --detach \
       --network host \
       --env URI_SCHEME=<span class="st">&quot;dns&quot;</span> \
       --env PUBLISH_INTERFACE_NAME=<span class="st">&quot;enp0s3&quot;</span> \
       --env MCAST_INTERFACE_NAME=<span class="st">&quot;enp0s3&quot;</span> \
       --name socat-bootstrap-server \
       socat-bootstrap-server</code></pre></div>
<p>[Optional] Remove the Docker network.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">docker</span> network rm mcast_net</code></pre></div>
<p>[Optional] Recreate it.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">docker</span> network create \
             -d macvlan \
             --subnet=192.168.10.0/24 \
             --gateway=192.168.10.180 \
             -o parent=eth0 \
             mcast_net</code></pre></div>
<p>[Optional] Create and fill the tls and tsig volumes (VM2)</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">docker</span> volume create tls
<span class="kw">docker</span> volume create tsig
<span class="kw">docker</span> run --rm --name temp --volume tls:/tls --volume tsig:/tsig -dit alpine
<span class="kw">docker</span> cp ~/tls/. temp:/tls/
<span class="kw">docker</span> cp ~/tsig/. temp:/tsig/
<span class="kw">docker</span> stop temp
<span class="kw">rm</span> -rf tls</code></pre></div>
<p>Build the images.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">scp</span> -P 22222 -r ~/ws/ahf-docker/ r@10.0.0.2:~/</code></pre></div>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">docker</span> build \
            --tag socat-bootstrap-client \
            ~/ahf-docker/discovery-bootstrapping/multicast/plain/socat/client
<span class="kw">docker</span> stop hello-ahf-nodejs
<span class="kw">docker</span> rm hello-ahf-nodejs
<span class="kw">docker</span> build \
            --tag hello-ahf-nodejs \
            ~/ahf-docker/examples/hello-ahf-nodejs</code></pre></div>
<p>Run the containers.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">docker</span> volume create bootstrapping
<span class="kw">docker</span> run \
           --rm \
           --network host \
           --name socat-bootstrap-client \
           --env OUTPUT_FILENAME=<span class="st">&quot;bootstrap&quot;</span> \
           --volume bootstrapping:/out \
           socat-bootstrap-client
<span class="kw">docker</span> run \
           --rm \
           --network host \
           --name hello-ahf-nodejs \
           --hostname hello.docker.ahf \
           -p 3111:3111 \
           --volume tls:/tls \
           --volume tsig:/tsig \
           --volume bootstrapping:/boots \
           --env REGISTER_WITH_DNS=true \
           --env BOOTSTRAPPING_PATH=<span class="st">&quot;/boots/bootstrap&quot;</span> \
           hello-ahf-nodejs</code></pre></div>
<p>Alternatively, run the containers detached and to restart always.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">docker</span> volume create bootstrapping
<span class="kw">docker</span> run \
           --restart always \
           --detach \
           --network host \
           --name socat-bootstrap-client \
           --env OUTPUT_FILENAME=<span class="st">&quot;bootstrap&quot;</span> \
           --volume bootstrapping:/out \
           socat-bootstrap-client
<span class="kw">docker</span> run \
           --restart always \
           --detach \
           --network host \
           --name hello-ahf-nodejs \
           --hostname hello.docker.ahf \
           -p 3111:3111 \
           --volume tls:/tls \
           --volume tsig:/tsig \
           --volume bootstrapping:/boots \
           --env REGISTER_WITH_DNS=true \
           --env BOOTSTRAPPING_PATH=<span class="st">&quot;/boots/bootstrap&quot;</span> \
           --env IP_INTERFACE_NAME=<span class="st">&quot;enp0s3&quot;</span> \
           --env DO_DYNAMIC_DNS_UPDATE=true \
           hello-ahf-nodejs</code></pre></div>
<p>Get the DNS server on the client</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">docker</span> run \
           --rm \
           --network host \
           --name socat-bootstrap-client \
           --env OUTPUT_FILENAME=<span class="st">&quot;bootstrap&quot;</span> \
           --volume bootstrapping:/out \
           socat-bootstrap-client <span class="kw">|</span> <span class="kw">sed</span> -E <span class="st">'s/.* (.*)/nameserver \1/g'</span> <span class="kw">&gt;</span> resolv.conf
<span class="kw">sudo</span> cp -f <span class="dt">{.,/etc}</span>/resolv.conf
<span class="kw">ping</span> glassfish.docker.ahf
<span class="kw">ping</span> hello.docker.ahf</code></pre></div>
<p>Test</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">curl</span> -X GET --cert ~/tls/client.pem:changeit --cacert ~/tls/ca.crt https://hello.docker.ahf:3111/setup
<span class="kw">curl</span> -X GET --cert ~/tls/client.pem:changeit --cacert ~/tls/ca.crt https://hello.docker.ahf:3111/hello
<span class="kw">curl</span> -X GET --cert ~/tls/client.pem:changeit --cacert ~/tls/ca.crt https://hello.docker.ahf:3111/setdown
<span class="kw">curl</span> -X GET --cert ~/tls/client.pem:changeit --cacert ~/tls/ca.crt https://hello.docker.ahf:3111/hello</code></pre></div>
<p>Change net</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">VBoxManage</span> controlvm <span class="st">&quot;ud1&quot;</span> nic1 natnetwork net192 <span class="kw">&amp;&amp;</span> <span class="kw">\</span>
<span class="kw">VBoxManage</span> controlvm <span class="st">&quot;ud2&quot;</span> nic1 natnetwork net192 <span class="kw">&amp;&amp;</span> <span class="kw">\</span>
<span class="kw">VBoxManage</span> controlvm <span class="st">&quot;ud3&quot;</span> nic1 natnetwork net192

<span class="kw">sudo</span> systemctl restart networking.service</code></pre></div>
<p>Clean up Host</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">VBoxManage</span> controlvm <span class="st">&quot;ud1&quot;</span> nic1 natnetwork net10 <span class="kw">&amp;&amp;</span> <span class="kw">\</span>
<span class="kw">VBoxManage</span> controlvm <span class="st">&quot;ud2&quot;</span> nic1 natnetwork net10 <span class="kw">&amp;&amp;</span> <span class="kw">\</span>
<span class="kw">VBoxManage</span> controlvm <span class="st">&quot;ud3&quot;</span> nic1 natnetwork net10
<span class="kw">VBoxManage</span> controlvm <span class="st">&quot;ud1&quot;</span> acpipowerbutton
<span class="kw">VBoxManage</span> controlvm <span class="st">&quot;ud2&quot;</span> acpipowerbutton
<span class="kw">VBoxManage</span> controlvm <span class="st">&quot;ud3&quot;</span> acpipowerbutton</code></pre></div>
<p>All VMS</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">sudo</span> systemctl restart networking.service</code></pre></div>
<ul>
<li><p>Start the VMs</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">VBoxManage</span> startvm ud1 --type headless
<span class="kw">VBoxManage</span> startvm ud2 --type headless
<span class="kw">VBoxManage</span> startvm ud3 --type headless
<span class="kw">ssh</span> r@10.0.0.1 -p22222
<span class="kw">ssh</span> r@10.0.0.2 -p22222
<span class="kw">ssh</span> r@10.0.0.3 -p22222</code></pre></div></li>
</ul>
<p>VM 3</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">sudo</span> cp -f /etc/resolv.conf<span class="dt">{.bkp,}</span>
<span class="kw">rm</span> -rf client</code></pre></div>
<p>Extra</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ot">vm=</span>ud3 <span class="kw">&amp;&amp;</span> <span class="kw">VBoxManage</span> controlvm <span class="st">&quot;</span><span class="ot">$vm</span><span class="st">&quot;</span> nic1 natnetwork net192 <span class="kw">&amp;&amp;</span> <span class="kw">VBoxManage</span> controlvm <span class="ot">$vm</span> setlinkstate1 off <span class="kw">&amp;&amp;</span> <span class="kw">VBoxManage</span> controlvm <span class="ot">$vm</span> setlinkstate1 on</code></pre></div>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">VBoxManage</span> controlvm ud1 setlinkstate1 off
<span class="kw">VBoxManage</span> controlvm ud2 setlinkstate1 off
<span class="kw">VBoxManage</span> controlvm ud3 setlinkstate1 off
<span class="kw">VBoxManage</span> controlvm ud1 setlinkstate1 on
<span class="kw">VBoxManage</span> controlvm ud2 setlinkstate1 on
<span class="kw">VBoxManage</span> controlvm ud3 setlinkstate1 on</code></pre></div>
</body>
</html>
